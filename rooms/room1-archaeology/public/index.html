<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Legacy Shop (Room 1)</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    .card { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
    .error { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
    code { background: #eee; padding: 0.2rem; }
    button { cursor: pointer; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h1>üèö Legacy Shop (Room 1)</h1>
  <p>Bem-vindo √† loja legacy. O c√≥digo √© antigo, mas "funciona" (achamos n√≥s).</p>

  <div class="card" id="login-section">
    <h2>1. Login</h2>
    <input type="text" id="username" value="Alice" placeholder="Username" />
    <input type="password" id="password" value="secret123" placeholder="Password" />
    <button onclick="doLogin()">Entrar</button>
    <div id="login-msg"></div>
  </div>

  <div class="card" id="shop-section" style="display:none; opacity: 0.5;">
    <h2>2. Checkout</h2>
    <p>Items: <b>2x "Mystery Box"</b> (1000‚Ç¨ cada)</p>
    <p>Subtotal: 2000‚Ç¨</p>
    <p>Discount Code: <input type="text" id="discount" value="WELCOME10" /> (10%)</p>
    <p>Shipping to: <b>Portugal</b> (Shipping: 450‚Ç¨ flat rate)</p>
    <button onclick="doCheckout()">Place Order</button>

    <h3>Fatura Gerada:</h3>
    <pre id="invoice-result" style="background:#f4f4f4; padding:1rem;">...</pre>
    
    <div id="bug-hint" style="display:none; border-left: 5px solid orange; padding-left: 10px;">
      <p>üßê <b>Espera...</b> Faz as contas √† m√£o.</p>
      <ul>
        <li>Subtotal: 2000‚Ç¨</li>
        <li>Discount: -200‚Ç¨ (10%)</li>
        <li>Shipping: +450‚Ç¨</li>
        <li><b>Taxable Base:</b> devia ser (2000 - 200 + 450) = 2250‚Ç¨?</li>
        <li><b>IVA (23%):</b> 2250 * 0.23 = <b>517.50‚Ç¨</b></li>
      </ul>
      <p>O que apareceu na fatura? Se for diferente, encontraste o Bug!</p>
    </div>
  </div>

  <script>
    let token = null;

    async function doLogin() {
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: u, password: p })
        });
        const data = await res.json();
        if (data.ok) {
          token = data.token;
          document.getElementById('login-msg').innerHTML = `<span class="success">Login OK! Token: ${token.substring(0,8)}...</span>`;
          document.getElementById('shop-section').style.display = 'block';
          document.getElementById('shop-section').style.opacity = '1';
        } else {
          document.getElementById('login-msg').innerHTML = `<span class="error">${data.error}</span>`;
        }
      } catch (e) {
        alert('Erro de rede: ' + e);
      }
    }

    async function doCheckout() {
      if (!token) return alert('Faz login primeiro!');
      const discount = document.getElementById('discount').value;
      
      const cart = [ { sku: 'MysteryBox', qty: 2, priceCents: 100000 } ]; // 1000 eur * 100

      const res = await fetch('/api/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          token, 
          cart, 
          discountCode: discount,
          shippingAddress: { country: 'PT' }
        })
      });
      const data = await res.json();
      
      const fmt = (cents) => (cents / 100).toFixed(2) + '‚Ç¨';

      if (data.ok) {
        const amt = data.order.amounts;
        const html = `
Ref: ${data.order.id}
--------------------------------
Subtotal: ${fmt(amt.subtotalCents)}
Discount: -${fmt(amt.discountCents)}
Shipping: +${fmt(amt.shippingCents)}
Tax (IVA): ${fmt(amt.taxCents)}  <-- VERIFICA ISTO
--------------------------------
TOTAL:    ${fmt(amt.totalCents)}
        `;
        document.getElementById('invoice-result').innerText = html;
        document.getElementById('bug-hint').style.display = 'block';
      } else {
        document.getElementById('invoice-result').innerText = 'Error: ' + JSON.stringify(data);
      }
    }
  </script>
</body>
</html>
